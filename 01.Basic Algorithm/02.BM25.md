# BM25

BM25是信息检索领域用来计算query和文档document相似度得分的经典算法

## 计算

给定一个query：Q，该query包含单词$q_1,q_2, ...,q_n$，该query针对文档d的BM25值为：
$$
score(q, d, D) = \sum\limits_{i=1}^{n}IDF(q_i, D) \cdot \frac{f(q_i, d) \cdot (k_1+1)}{f(q_i, d)+k_1 \cdot (1-b+b \cdot \frac{|d|}{\rm{avgdl}})}
\\
IDF(q_i, D) = {\rm In} (\frac{|D|-n(q_i)+0.5}{n(q_i)+0.5}+1)
$$
其中：

1. D表示候选文档集合，$|D|$表示候选文档集合中的文档个数

2. $f(q_i, d)$表示单词$q_i$在文档d中的词频，$|d|$表示文档d的长度（这里即文档d中的单词个数？），$\rm{avgdl}$表示文档集合D中的平均文档长度

3. $k_1$和$b$是超参数，通常：$k_1 \in [1.2, 2.0],  b=0.75$

4. $IDF(q_i, D)$是单词$q_i$的逆文档频率，$n(q_i)$是包含有单词$q_i$的文档个数

   > 注意：wikipedia中，使用$D$来表示特定的某个文档，我这里使用小写$d$来表示某个文档，使用$D$来表示整个文档集合

## Code：

```python
corpus = [
    ['来', '问', '几', '个', '问题', '第1', '个', '就', '是', '60', '岁', '60', '岁', '的', '时候', '退休', '是', '时间', '到', '了', '一定', '要', '退休', '还是', '觉得', '应该', '差', '不', '多'],
    ['第1', '个', '是', '应该', '第2', '个', '是'],
    ['不', '对', '应该', '就是', '差', '不', '多'],
    ['所以', '是', '应该', '差', '不', '多', '还是', '一定', '要', '退', '61', '岁']
]

my_bm25 = bm25(corpus)

test_sens = [
    ['所以', '是', '应该', '差', '不', '多', '还是', '一定', '要', '退', '60', '岁'],
    ['所以', '是', '应该', '差', '不', '多', '还是', '一定', '要', '退', '60', '岁', '问题', '第1', '个'],
    ['所以', '是', '应该', '差', '不', '多', '还是', '一定', '要', '退', '60', '岁', '问题', '第1', '个', '来', '问', '几', '个', '问题'],
    ['应该', '差', '不', '多', '一定', '要', '退', '60', '岁'],
    ['差', '不', '多', '一定', '要', '退'],
    ['一定', '要', '差', '不', '多', '退'],
    ['一定', '要', '退'],
    ['一定', '差', '不', '多'],
]
for each_sen in test_sens:
    scores = my_bm25.get_scores(each_sen)
    print('测试句子：', each_sen)
    for i, j in zip(scores, corpus):
        print(f'分值：{i:.3f},\t原句：{"".join(j)}')
    print('\n')
'''
--------------------Result:-----------------------
'''
测试句子： ['所以', '是', '应该', '差', '不', '多', '还是', '一定', '要', '退', '60', '岁']
分值：1.218,	原句：来问几个问题第1个就是60岁60岁的时候退休是时间到了一定要退休还是觉得应该差不多
分值：0.261,	原句：第1个是应该第2个是
分值：0.486,	原句：不对应该就是差不多
分值：2.262,	原句：所以是应该差不多还是一定要退61岁


测试句子： ['所以', '是', '应该', '差', '不', '多', '还是', '一定', '要', '退', '60', '岁', '问题', '第1', '个']
分值：1.784,	原句：来问几个问题第1个就是60岁60岁的时候退休是时间到了一定要退休还是觉得应该差不多
分值：0.261,	原句：第1个是应该第2个是
分值：0.486,	原句：不对应该就是差不多
分值：2.262,	原句：所以是应该差不多还是一定要退61岁


测试句子： ['所以', '是', '应该', '差', '不', '多', '还是', '一定', '要', '退', '60', '岁', '问题', '第1', '个', '来', '问', '几', '个', '问题']
分值：4.044,	原句：来问几个问题第1个就是60岁60岁的时候退休是时间到了一定要退休还是觉得应该差不多
分值：0.261,	原句：第1个是应该第2个是
分值：0.486,	原句：不对应该就是差不多
分值：2.262,	原句：所以是应该差不多还是一定要退61岁


测试句子： ['应该', '差', '不', '多', '一定', '要', '退', '60', '岁']
分值：1.126,	原句：来问几个问题第1个就是60岁60岁的时候退休是时间到了一定要退休还是觉得应该差不多
分值：0.112,	原句：第1个是应该第2个是
分值：0.486,	原句：不对应该就是差不多
分值：1.270,	原句：所以是应该差不多还是一定要退61岁


测试句子： ['差', '不', '多', '一定', '要', '退']
分值：0.175,	原句：来问几个问题第1个就是60岁60岁的时候退休是时间到了一定要退休还是觉得应该差不多
分值：0.000,	原句：第1个是应该第2个是
分值：0.373,	原句：不对应该就是差不多
分值：1.178,	原句：所以是应该差不多还是一定要退61岁


测试句子： ['一定', '要', '差', '不', '多', '退']
分值：0.175,	原句：来问几个问题第1个就是60岁60岁的时候退休是时间到了一定要退休还是觉得应该差不多
分值：0.000,	原句：第1个是应该第2个是
分值：0.373,	原句：不对应该就是差不多
分值：1.178,	原句：所以是应该差不多还是一定要退61岁


测试句子： ['一定', '要', '退']
分值：0.000,	原句：来问几个问题第1个就是60岁60岁的时候退休是时间到了一定要退休还是觉得应该差不多
分值：0.000,	原句：第1个是应该第2个是
分值：0.000,	原句：不对应该就是差不多
分值：0.899,	原句：所以是应该差不多还是一定要退61岁


测试句子： ['一定', '差', '不', '多']
分值：0.175,	原句：来问几个问题第1个就是60岁60岁的时候退休是时间到了一定要退休还是觉得应该差不多
分值：0.000,	原句：第1个是应该第2个是
分值：0.373,	原句：不对应该就是差不多
分值：0.279,	原句：所以是应该差不多还是一定要退61岁
```

# 参考

1. [BM25算法, Best Matching](https://zhuanlan.zhihu.com/p/79202151)
2. [BM25算法的通俗理解](https://zhuanlan.zhihu.com/p/420048609)
3. [Okapi BM25](https://en.wikipedia.org/wiki/Okapi_BM25)